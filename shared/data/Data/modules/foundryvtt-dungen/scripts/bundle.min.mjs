class e{static ID="foundryvtt-dungen";static API="https://ttrpg.ink/api";static OPTIONS={background:"#7030A0",color:"#fff",LOG_LEVEL:[{title:"OFF",background:"#000",color:"#fff"},{title:"ERROR",background:"#F93154",color:"#fff"},{title:"WARN",background:"#FFA900",color:"#fff"},{title:"DEBUG",background:"#B23CFD",color:"#fff"},{title:"INFO",background:"#39C0ED",color:"#fff"},{title:"LOG",background:"#39C0ED",color:"#fff"}]};static get TITLE(){return this.localize("title")}static localize(e,t={}){return foundry.utils.isEmpty(t.hash??{})?game.i18n.localize(`${this.ID}.${e}`):game.i18n.format(`${this.ID}.${e}`,t)}static CONSOLE=(e,...t)=>{try{game.modules.get("_dev-mode")?.api?.getPackageDebugValue(this.ID,"level")>=e&&console.log(`%c${this.TITLE}%c${this.OPTIONS.LOG_LEVEL[e].title}`,`background-color: ${this.OPTIONS.background}; border-radius: 2px; color: ${this.OPTIONS.color}; padding: 0.15rem 0.25rem;`,`background-color: ${this.OPTIONS.LOG_LEVEL[e].background}; border-radius: 2px; color: ${this.OPTIONS.LOG_LEVEL[e].color}; padding: 0.15rem 0.25rem; margin-left: 0.25rem;${e>=4?"display:none":""}`,...t)}catch(e){console.warn(`${this.TITLE} debug logging failed`,e)}};static log=(...e)=>{this.CONSOLE(5,...e)};static info=(...e)=>{this.CONSOLE(4,...e)};static debug=(...e)=>{this.CONSOLE(3,...e)};static warn=(...e)=>{this.CONSOLE(2,...e)};static error=(...e)=>{this.CONSOLE(1,...e)};static setting=(...t)=>{if("register"==t[0].toLowerCase()){let e=t[1],n=t[2],i={name:this.localize(`settings.${e}.name`),hint:this.localize(`settings.${e}.hint`),scope:"client",config:!0},s=foundry.utils.mergeObject(i,n,{inplace:!1});return game.settings.register(this.ID,e,s),s}{let n=t[0];if(void 0!==t[1])return game.settings.set(this.ID,n,t[1]);try{return game.settings.get(this.ID,n)}catch{return void e.error(`${n} is not a registered game setting`)}}}}function t(e){if(p(e)){const n={};for(let i=0;i<e.length;i++){const s=e[i],r=g(s)?o(s):t(s);if(r)for(const e in r)n[e]=r[e]}return n}return g(e)||v(e)?e:void 0}const n=/;(?![^(]*\))/g,i=/:([^]+)/,s=/\/\*.*?\*\//gs;function o(e){const t={};return e.replace(s,"").split(n).forEach((e=>{if(e){const n=e.split(i);n.length>1&&(t[n[0].trim()]=n[1].trim())}})),t}function r(e){let t="";if(g(e))t=e;else if(p(e))for(let n=0;n<e.length;n++){const i=r(e[n]);i&&(t+=i+" ")}else if(v(e))for(const n in e)e[n]&&(t+=n+" ");return t.trim()}function a(e,t){if(e===t)return!0;let n=f(e),i=f(t);if(n||i)return!(!n||!i)&&e.getTime()===t.getTime();if(n=m(e),i=m(t),n||i)return e===t;if(n=p(e),i=p(t),n||i)return!(!n||!i)&&function(e,t){if(e.length!==t.length)return!1;let n=!0;for(let i=0;n&&i<e.length;i++)n=a(e[i],t[i]);return n}(e,t);if(n=v(e),i=v(t),n||i){if(!n||!i)return!1;if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e){const i=e.hasOwnProperty(n),s=t.hasOwnProperty(n);if(i&&!s||!i&&s||!a(e[n],t[n]))return!1}}return String(e)===String(t)}function l(e,t){return e.findIndex((e=>a(e,t)))}const c=Object.assign,u=Object.prototype.hasOwnProperty,d=(e,t)=>u.call(e,t),p=Array.isArray,h=e=>"[object Map]"===b(e),f=e=>"[object Date]"===b(e),g=e=>"string"==typeof e,m=e=>"symbol"==typeof e,v=e=>null!==e&&"object"==typeof e,y=Object.prototype.toString,b=e=>y.call(e),_=e=>g(e)&&"NaN"!==e&&"-"!==e[0]&&""+parseInt(e,10)===e,w=e=>{const t=Object.create(null);return n=>t[n]||(t[n]=e(n))},S=/-(\w)/g,O=w((e=>e.replace(S,((e,t)=>t?t.toUpperCase():"")))),x=/\B([A-Z])/g,E=w((e=>e.replace(x,"-$1").toLowerCase())),k=e=>{const t=parseFloat(e);return isNaN(t)?e:t};function I(e,t){t&&t.active&&t.effects.push(e)}const T=e=>{const t=new Set(e);return t.w=0,t.n=0,t},A=e=>(e.w&L)>0,D=e=>(e.n&L)>0,z=new WeakMap;let P=0,L=1;let j;const M=Symbol(""),R=Symbol("");class C{constructor(e,t=null,n){this.fn=e,this.scheduler=t,this.active=!0,this.deps=[],this.parent=void 0,I(this,n)}run(){if(!this.active)return this.fn();let e=j,t=F;for(;e;){if(e===this)return;e=e.parent}try{return this.parent=j,j=this,F=!0,L=1<<++P,P<=30?(({deps:e})=>{if(e.length)for(let t=0;t<e.length;t++)e[t].w|=L})(this):q(this),this.fn()}finally{P<=30&&(e=>{const{deps:t}=e;if(t.length){let n=0;for(let i=0;i<t.length;i++){const s=t[i];A(s)&&!D(s)?s.delete(e):t[n++]=s,s.w&=~L,s.n&=~L}t.length=n}})(this),L=1<<--P,j=this.parent,F=t,this.parent=void 0,this.deferStop&&this.stop()}}stop(){j===this?this.deferStop=!0:this.active&&(q(this),this.onStop&&this.onStop(),this.active=!1)}}function q(e){const{deps:t}=e;if(t.length){for(let n=0;n<t.length;n++)t[n].delete(e);t.length=0}}function N(e){e.effect.stop()}let F=!0;const H=[];function W(e,t,n){if(F&&j){let t=z.get(e);t||z.set(e,t=new Map);let i=t.get(n);i||t.set(n,i=T()),function(e,t){let n=!1;P<=30?D(e)||(e.n|=L,n=!A(e)):n=!e.has(j),n&&(e.add(j),j.deps.push(e))}(i)}}function G(e,t,n,i,s,o){const r=z.get(e);if(!r)return;let a=[];if("clear"===t)a=[...r.values()];else if("length"===n&&p(e)){const e=k(i);r.forEach(((t,n)=>{("length"===n||n>=e)&&a.push(t)}))}else switch(void 0!==n&&a.push(r.get(n)),t){case"add":p(e)?_(n)&&a.push(r.get("length")):(a.push(r.get(M)),h(e)&&a.push(r.get(R)));break;case"delete":p(e)||(a.push(r.get(M)),h(e)&&a.push(r.get(R)));break;case"set":h(e)&&a.push(r.get(M))}if(1===a.length)a[0]&&V(a[0]);else{const e=[];for(const t of a)t&&e.push(...t);V(T(e))}}function V(e,t){const n=p(e)?e:[...e];for(const e of n)e.computed&&X(e);for(const e of n)e.computed||X(e)}function X(e,t){(e!==j||e.allowRecurse)&&(e.scheduler?e.scheduler():e.run())}const B=function(e,t){const n=Object.create(null),i=e.split(",");for(let e=0;e<i.length;e++)n[i[e]]=!0;return t?e=>!!n[e.toLowerCase()]:e=>!!n[e]}("__proto__,__v_isRef,__isVue"),Z=new Set(Object.getOwnPropertyNames(Symbol).filter((e=>"arguments"!==e&&"caller"!==e)).map((e=>Symbol[e])).filter(m)),Y=K(),U=K(!0),J=function(){const e={};return["includes","indexOf","lastIndexOf"].forEach((t=>{e[t]=function(...e){const n=ce(this);for(let e=0,t=this.length;e<t;e++)W(n,0,e+"");const i=n[t](...e);return-1===i||!1===i?n[t](...e.map(ce)):i}})),["push","pop","shift","unshift","splice"].forEach((t=>{e[t]=function(...e){H.push(F),F=!1;const n=ce(this)[t].apply(this,e);return function(){const e=H.pop();F=void 0===e||e}(),n}})),e}();function K(e=!1,t=!1){return function(n,i,s){if("__v_isReactive"===i)return!e;if("__v_isReadonly"===i)return e;if("__v_isShallow"===i)return t;if("__v_raw"===i&&s===(e?t?se:ie:t?ne:te).get(n))return n;const o=p(n);if(!e&&o&&d(J,i))return Reflect.get(J,i,s);const r=Reflect.get(n,i,s);return(m(i)?Z.has(i):B(i))||(e||W(n,0,i),t)?r:ue(r)?o&&_(i)?r:r.value:v(r)?e?function(e){return ae(e,!0,ee,null,ie)}(r):re(r):r}}const Q={get:Y,set:function(e=!1){return function(t,n,i,s){let o=t[n];if(le(o)&&ue(o)&&!ue(i))return!1;if(!e&&(!function(e){return!(!e||!e.__v_isShallow)}(i)&&!le(i)&&(o=ce(o),i=ce(i)),!p(t)&&ue(o)&&!ue(i)))return o.value=i,!0;const r=p(t)&&_(n)?Number(n)<t.length:d(t,n),a=Reflect.set(t,n,i,s);return t===ce(s)&&(r?((e,t)=>!Object.is(e,t))(i,o)&&G(t,"set",n,i):G(t,"add",n,i)),a}}(),deleteProperty:function(e,t){const n=d(e,t);e[t];const i=Reflect.deleteProperty(e,t);return i&&n&&G(e,"delete",t,void 0),i},has:function(e,t){const n=Reflect.has(e,t);return(!m(t)||!Z.has(t))&&W(e,0,t),n},ownKeys:function(e){return W(e,0,p(e)?"length":M),Reflect.ownKeys(e)}},ee={get:U,set:(e,t)=>!0,deleteProperty:(e,t)=>!0},te=new WeakMap,ne=new WeakMap,ie=new WeakMap,se=new WeakMap;function oe(e){return e.__v_skip||!Object.isExtensible(e)?0:function(e){switch(e){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}((e=>b(e).slice(8,-1))(e))}function re(e){return le(e)?e:ae(e,!1,Q,null,te)}function ae(e,t,n,i,s){if(!v(e)||e.__v_raw&&(!t||!e.__v_isReactive))return e;const o=s.get(e);if(o)return o;const r=oe(e);if(0===r)return e;const a=new Proxy(e,2===r?i:n);return s.set(e,a),a}function le(e){return!(!e||!e.__v_isReadonly)}function ce(e){const t=e&&e.__v_raw;return t?ce(t):e}function ue(e){return!(!e||!0!==e.__v_isRef)}let de=!1;const pe=[],he=Promise.resolve(),fe=e=>he.then(e),ge=e=>{pe.includes(e)||pe.push(e),de||(de=!0,fe(me))},me=()=>{for(const e of pe)e();pe.length=0,de=!1},ve=/^(spellcheck|draggable|form|list|type)$/,ye=({el:e,get:t,effect:n,arg:i,modifiers:s})=>{let o;"class"===i&&(e._class=e.className),n((()=>{let n=t();if(i)null!=s&&s.camel&&(i=O(i)),be(e,i,n,o);else{for(const t in n)be(e,t,n[t],o&&o[t]);for(const t in o)(!n||!(t in n))&&be(e,t,null)}o=n}))},be=(e,n,i,s)=>{if("class"===n)e.setAttribute("class",r(e._class?[e._class,i]:i)||"");else if("style"===n){i=t(i);const{style:n}=e;if(i)if(g(i))i!==s&&(n.cssText=i);else{for(const e in i)we(n,e,i[e]);if(s&&!g(s))for(const e in s)null==i[e]&&we(n,e,"")}else e.removeAttribute("style")}else e instanceof SVGElement||!(n in e)||ve.test(n)?"true-value"===n?e._trueValue=i:"false-value"===n?e._falseValue=i:null!=i?e.setAttribute(n,i):e.removeAttribute(n):(e[n]=i,"value"===n&&(e._value=i))},_e=/\s*!important$/,we=(e,t,n)=>{p(n)?n.forEach((n=>we(e,t,n))):t.startsWith("--")?e.setProperty(t,n):_e.test(n)?e.setProperty(E(t),n.replace(_e,""),"important"):e[t]=n},Se=(e,t)=>{const n=e.getAttribute(t);return null!=n&&e.removeAttribute(t),n},Oe=(e,t,n,i)=>{e.addEventListener(t,n,i)},xe=/^[A-Za-z_$][\w$]*(?:\.[A-Za-z_$][\w$]*|\['[^']*?']|\["[^"]*?"]|\[\d+]|\[[A-Za-z_$][\w$]*])*$/,Ee=["ctrl","shift","alt","meta"],ke={stop:e=>e.stopPropagation(),prevent:e=>e.preventDefault(),self:e=>e.target!==e.currentTarget,ctrl:e=>!e.ctrlKey,shift:e=>!e.shiftKey,alt:e=>!e.altKey,meta:e=>!e.metaKey,left:e=>"button"in e&&0!==e.button,middle:e=>"button"in e&&1!==e.button,right:e=>"button"in e&&2!==e.button,exact:(e,t)=>Ee.some((n=>e[`${n}Key`]&&!t[n]))},$e=({el:e,get:t,exp:n,arg:i,modifiers:s})=>{if(!i)return;let o=xe.test(n)?t(`(e => ${n}(e))`):t(`($event => { ${n} })`);if("vue:mounted"!==i){if("vue:unmounted"===i)return()=>o();if(s){"click"===i&&(s.right&&(i="contextmenu"),s.middle&&(i="mouseup"));const e=o;o=t=>{if(!("key"in t)||E(t.key)in s){for(const e in s){const n=ke[e];if(n&&n(t,s))return}return e(t)}}}Oe(e,i,o,s)}else fe(o)},Ie=({el:e,get:t,effect:n})=>{n((()=>{e.textContent=Te(t())}))},Te=e=>null==e?"":v(e)?JSON.stringify(e,null,2):String(e),Ae=e=>"_value"in e?e._value:e.value,De=(e,t)=>{const n=t?"_trueValue":"_falseValue";return n in e?e[n]:t},ze=e=>{e.target.composing=!0},Pe=e=>{const t=e.target;t.composing&&(t.composing=!1,Le(t,"input"))},Le=(e,t)=>{const n=document.createEvent("HTMLEvents");n.initEvent(t,!0,!0),e.dispatchEvent(n)},je=Object.create(null),Me=(e,t,n)=>Re(e,`return(${t})`,n),Re=(e,t,n)=>{const i=je[t]||(je[t]=Ce(t));try{return i(e,n)}catch(e){console.error(e)}},Ce=e=>{try{return new Function("$data","$el",`with($data){${e}}`)}catch(t){return console.error(`${t.message} in expression: ${e}`),()=>{}}},qe={bind:ye,on:$e,show:({el:e,get:t,effect:n})=>{const i=e.style.display;n((()=>{e.style.display=t()?i:"none"}))},text:Ie,html:({el:e,get:t,effect:n})=>{n((()=>{e.innerHTML=t()}))},model:({el:e,exp:t,get:n,effect:i,modifiers:s})=>{const o=e.type,r=n(`(val) => { ${t} = val }`),{trim:c,number:u="number"===o||"range"===o}=s||{};if("SELECT"===e.tagName){const t=e;Oe(e,"change",(()=>{const e=Array.prototype.filter.call(t.options,(e=>e.selected)).map((e=>u?k(Ae(e)):Ae(e)));r(t.multiple?e:e[0])})),i((()=>{const e=n(),i=t.multiple;for(let n=0,s=t.options.length;n<s;n++){const s=t.options[n],o=Ae(s);if(i)p(e)?s.selected=l(e,o)>-1:s.selected=e.has(o);else if(a(Ae(s),e))return void(t.selectedIndex!==n&&(t.selectedIndex=n))}!i&&-1!==t.selectedIndex&&(t.selectedIndex=-1)}))}else if("checkbox"===o){let t;Oe(e,"change",(()=>{const t=n(),i=e.checked;if(p(t)){const n=Ae(e),s=l(t,n),o=-1!==s;if(i&&!o)r(t.concat(n));else if(!i&&o){const e=[...t];e.splice(s,1),r(e)}}else r(De(e,i))})),i((()=>{const i=n();p(i)?e.checked=l(i,Ae(e))>-1:i!==t&&(e.checked=a(i,De(e,!0))),t=i}))}else if("radio"===o){let t;Oe(e,"change",(()=>{r(Ae(e))})),i((()=>{const i=n();i!==t&&(e.checked=a(i,Ae(e)))}))}else{const t=e=>c?e.trim():u?k(e):e;Oe(e,"compositionstart",ze),Oe(e,"compositionend",Pe),Oe(e,null!=s&&s.lazy?"change":"input",(()=>{e.composing||r(t(e.value))})),c&&Oe(e,"change",(()=>{e.value=e.value.trim()})),i((()=>{if(e.composing)return;const i=e.value,s=n();document.activeElement===e&&t(i)===s||i!==s&&(e.value=s)}))}},effect:({el:e,ctx:t,exp:n,effect:i})=>{fe((()=>i((()=>Re(t.scope,n,e)))))}},Ne=/([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/,Fe=/,([^,\}\]]*)(?:,([^,\}\]]*))?$/,He=/^\(|\)$/g,We=/^[{[]\s*((?:[\w_$]+\s*,?\s*)+)[\]}]$/,Ge=(e,t,n)=>{const i=t.match(Ne);if(!i)return;const s=e.nextSibling,o=e.parentElement,r=new Text("");o.insertBefore(r,e),o.removeChild(e);const a=i[2].trim();let l,c,u,d,h=i[1].trim().replace(He,"").trim(),f=!1,g="key",m=e.getAttribute(g)||e.getAttribute(g=":key")||e.getAttribute(g="v-bind:key");m&&(e.removeAttribute(g),"key"===g&&(m=JSON.stringify(m))),(d=h.match(Fe))&&(h=h.replace(Fe,"").trim(),c=d[1].trim(),d[2]&&(u=d[2].trim())),(d=h.match(We))&&(l=d[1].split(",").map((e=>e.trim())),f="["===h[0]);let y,b,_,w=!1;const S=(e,t,i,s)=>{const o={};l?l.forEach(((e,n)=>o[e]=t[f?n:e])):o[h]=t,s?(c&&(o[c]=s),u&&(o[u]=i)):c&&(o[c]=i);const r=tt(n,o),a=m?Me(r.scope,m):i;return e.set(a,i),r.key=a,r},O=(t,n)=>{const i=new it(e,t);return i.key=t.key,i.insert(o,n),i};return n.effect((()=>{const e=Me(n.scope,a),t=_;if([b,_]=(e=>{const t=new Map,n=[];if(p(e))for(let i=0;i<e.length;i++)n.push(S(t,e[i],i));else if("number"==typeof e)for(let i=0;i<e;i++)n.push(S(t,i+1,i));else if(v(e)){let i=0;for(const s in e)n.push(S(t,e[s],i++,s))}return[n,t]})(e),w){for(let e=0;e<y.length;e++)_.has(y[e].key)||y[e].remove();const e=[];let n,i,s=b.length;for(;s--;){const a=b[s],l=t.get(a.key);let c;null==l?c=O(a,n?n.el:r):(c=y[l],Object.assign(c.ctx.scope,a.scope),l!==s&&(y[l+1]!==n||i===n)&&(i=c,c.insert(o,n?n.el:r))),e.unshift(n=c)}y=e}else y=b.map((e=>O(e,r))),w=!0})),s},Ve=({el:e,ctx:{scope:{$refs:t}},get:n,effect:i})=>{let s;return i((()=>{const i=n();t[i]=e,s&&i!==s&&delete t[s],s=i})),()=>{s&&delete t[s]}},Xe=/^(?:v-|:|@)/,Be=/\.([\w-]+)/g;let Ze=!1;const Ye=(e,t)=>{const n=e.nodeType;if(1===n){const n=e;if(n.hasAttribute("v-pre"))return;let i;if(Se(n,"v-cloak"),i=Se(n,"v-if"))return((e,t,n)=>{const i=e.parentElement,s=new Comment("v-if");i.insertBefore(s,e);const o=[{exp:t,el:e}];let r,a;for(;(r=e.nextElementSibling)&&(a=null,""===Se(r,"v-else")||(a=Se(r,"v-else-if")));)i.removeChild(r),o.push({exp:a,el:r});const l=e.nextSibling;i.removeChild(e);let c,u=-1;const d=()=>{c&&(i.insertBefore(s,c.el),c.remove(),c=void 0)};return n.effect((()=>{for(let e=0;e<o.length;e++){const{exp:t,el:r}=o[e];if(!t||Me(n.scope,t))return void(e!==u&&(d(),c=new it(r,n),c.insert(i,s),i.removeChild(s),u=e))}u=-1,d()})),l})(n,i,t);if(i=Se(n,"v-for"))return Ge(n,i,t);if((i=Se(n,"v-scope"))||""===i){const e=i?Me(t.scope,i):{};t=tt(t,e),e.$template&&Qe(n,e.$template)}const s=null!=Se(n,"v-once");s&&(Ze=!0),(i=Se(n,"ref"))&&Ke(n,Ve,`"${i}"`,t),Ue(n,t);const o=[];for(const{name:e,value:i}of[...n.attributes])Xe.test(e)&&"v-cloak"!==e&&("v-model"===e?o.unshift([e,i]):"@"===e[0]||/^v-on\b/.test(e)?o.push([e,i]):Je(n,e,i,t));for(const[e,i]of o)Je(n,e,i,t);s&&(Ze=!1)}else if(3===n){const n=e.data;if(n.includes(t.delimiters[0])){let i,s=[],o=0;for(;i=t.delimitersRE.exec(n);){const e=n.slice(o,i.index);e&&s.push(JSON.stringify(e)),s.push(`$s(${i[1]})`),o=i.index+i[0].length}o<n.length&&s.push(JSON.stringify(n.slice(o))),Ke(e,Ie,s.join("+"),t)}}else 11===n&&Ue(e,t)},Ue=(e,t)=>{let n=e.firstChild;for(;n;)n=Ye(n,t)||n.nextSibling},Je=(e,t,n,i)=>{let s,o,r;if(":"===(t=t.replace(Be,((e,t)=>((r||(r={}))[t]=!0,""))))[0])s=ye,o=t.slice(1);else if("@"===t[0])s=$e,o=t.slice(1);else{const e=t.indexOf(":"),n=e>0?t.slice(2,e):t.slice(2);s=qe[n]||i.dirs[n],o=e>0?t.slice(e+1):void 0}s&&(s===ye&&"ref"===o&&(s=Ve),Ke(e,s,n,i,o,r),e.removeAttribute(t))},Ke=(e,t,n,i,s,o)=>{const r=t({el:e,get:(t=n)=>Me(i.scope,t,e),effect:i.effect,ctx:i,exp:n,arg:s,modifiers:o});r&&i.cleanups.push(r)},Qe=(e,t)=>{if("#"!==t[0])e.innerHTML=t;else{const n=document.querySelector(t);e.appendChild(n.content.cloneNode(!0))}},et=e=>{const t={delimiters:["{{","}}"],delimitersRE:/\{\{([^]+?)\}\}/g,...e,scope:e?e.scope:re({}),dirs:e?e.dirs:{},effects:[],blocks:[],cleanups:[],effect:e=>{if(Ze)return ge(e),e;const n=function(e,t){e.effect&&(e=e.effect.fn);const n=new C(e);t&&(c(n,t),t.scope&&I(n,t.scope)),(!t||!t.lazy)&&n.run();const i=n.run.bind(n);return i.effect=n,i}(e,{scheduler:()=>ge(n)});return t.effects.push(n),n}};return t},tt=(e,t={})=>{const n=e.scope,i=Object.create(n);Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)),i.$refs=Object.create(n.$refs);const s=re(new Proxy(i,{set:(e,t,i,o)=>o!==s||e.hasOwnProperty(t)?Reflect.set(e,t,i,o):Reflect.set(n,t,i)}));return nt(s),{...e,scope:s}},nt=e=>{for(const t of Object.keys(e))"function"==typeof e[t]&&(e[t]=e[t].bind(e))};class it{get el(){return this.start||this.template}constructor(e,t,n=!1){this.isFragment=e instanceof HTMLTemplateElement,n?this.template=e:this.isFragment?this.template=e.content.cloneNode(!0):this.template=e.cloneNode(!0),n?this.ctx=t:(this.parentCtx=t,t.blocks.push(this),this.ctx=et(t)),Ye(this.template,this.ctx)}insert(e,t=null){if(this.isFragment)if(this.start){let n,i=this.start;for(;i&&(n=i.nextSibling,e.insertBefore(i,t),i!==this.end);)i=n}else this.start=new Text(""),this.end=new Text(""),e.insertBefore(this.end,t),e.insertBefore(this.start,this.end),e.insertBefore(this.template,this.end);else e.insertBefore(this.template,t)}remove(){if(this.parentCtx&&((e,t)=>{const n=e.indexOf(t);n>-1&&e.splice(n,1)})(this.parentCtx.blocks,this),this.start){const e=this.start.parentNode;let t,n=this.start;for(;n&&(t=n.nextSibling,e.removeChild(n),n!==this.end);)n=t}else this.template.parentNode.removeChild(this.template);this.teardown()}teardown(){this.ctx.blocks.forEach((e=>{e.teardown()})),this.ctx.effects.forEach(N),this.ctx.cleanups.forEach((e=>e()))}}const st=e=>e.replace(/[-.*+?^${}()|[\]\/\\]/g,"\\$&"),ot=e=>{const t=et();if(e&&(t.scope=re(e),nt(t.scope),e.$delimiters)){const[n,i]=t.delimiters=e.$delimiters;t.delimitersRE=new RegExp(st(n)+"([^]+?)"+st(i),"g")}let n;return t.scope.$s=Te,t.scope.$nextTick=fe,t.scope.$refs=Object.create(null),{directive(e,n){return n?(t.dirs[e]=n,this):t.dirs[e]},mount(e){if("string"==typeof e&&!(e=document.querySelector(e)))return;let i;return i=(e=e||document.documentElement).hasAttribute("v-scope")?[e]:[...e.querySelectorAll("[v-scope]")].filter((e=>!e.matches("[v-scope] [v-scope]"))),i.length||(i=[e]),n=i.map((e=>new it(e,t,!0))),this},unmount(){n.forEach((e=>e.teardown()))}}},rt=document.currentScript;rt&&rt.hasAttribute("init")&&ot().mount();const at={template:{cache:new Map,get:async e=>at.template.cache.has(e)?at.template.cache.get(e):await fetch(e).then((e=>{if(!e.ok)throw Error(e.statusText);return e.text()})).then((t=>(at.template.cache.set(e,t),at.template.cache.get(e)))).catch((e=>(console.error(e),!1))),set:async e=>(at.template.cache.has(e)&&at.template.cache.delete(e),at.template.cache.get(e)),async delete(e){at.template.cache.delete(e)}},helpers:{localize:(e,t={})=>(foundry.utils?.isEmpty??foundry.utils?.isObjectEmpty)(t.hash??{})?game.i18n.localize(e):game.i18n.format(e,t),l:(...e)=>at.helpers.localize(...e)}};class lt extends Application{constructor(...e){super(...e)}get store(){return this._vue.store}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["vue-window-app"],submitOnClose:!1,submitOnInput:!1,autoUpdate:!1})}async _renderInner(e){let t=await at.template.get(this.template);if(""===t)throw Error(`No data was returned from template ${this.template}`);let n=Object.assign(document.createElement("div"),{innerHTML:`<div v-scope @vue:mounted="mounted($el)" @vue:unmounted="unmounted($el)">${t}</div>`}),i=re(e);return console.log(i),this._vue={store:i,app:null},$(n.firstChild)}async _activateCoreListeners(e){super._activateCoreListeners(e);let t=e[0];this._vue.app=ot(mergeObject({store:this._vue.store},mergeObject(at.helpers,{mounted:function(e){Hooks.callAll("mountedVueApplication",this,e)},unmounted:function(e){Hooks.callAll("unmountedVueApplication",this,e)}}))).mount(t.querySelector(".window-content > div"))}async close(e={}){let t=this.element[0],n=Application.RENDER_STATES;if(e.force||[n.RENDERED,n.ERROR].includes(this._state)){if(this._state=n.CLOSING,!t)return this._state=n.CLOSED;for(let e of this.constructor._getInheritanceChain())Hooks.call(`close${e.name}`,this,this.element);return await new Promise((e=>{t.addEventListener("transitionend",(i=>{this._vue.app.unmount(),this._vue=null,t.remove(),this._element=null,delete ui.windows[this.appId],this._minimized=!1,this._scrollPositions=null,this._state=n.CLOSED,e()}),{once:!0}),Object.assign(t.style,{transformOrigin:"top right",transition:"opacity 0.2s ease-in-out, height 0.2s ease-in-out",opacity:0,height:0})}))}}}class ct extends FormApplication{constructor(...e){super(...e),this._hookIds=[]}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["vue-window-app"],submitOnInput:!1,autoUpdate:!1})}get store(){return this._vue.store}getData(e={}){return{object:this.object?.toObject()??this.object,options:this.options,title:this.title}}async _renderInner(e){let t=await at.template.get(this.template);if(""===t)throw Error(`No data was returned from template ${this.template}`);let n=Object.assign(document.createElement("div"),{innerHTML:`<form @vue:mounted="mounted($el)" @vue:unmounted="unmounted($el)">${t}</form>`}),i=re(e.object);return this._vue={store:i,app:ot({store:i,...{...at.helpers,mounted:function(e){Hooks.callAll("mountedVueFormApplication",this,e)},unmounted:function(e){Hooks.callAll("unmountedVueFormApplication",this,e)}}}).mount(n.firstChild)},this.form=n.querySelector("form"),$(n.firstChild)}async _activateCoreListeners(e){if(super._activateCoreListeners(e),this.options.autoSync&&this.object?.update)for(let e of Object.values(this.object.schema.fields)){if(!e?.element?.documentName)continue;["create","update","delete"].forEach((t=>{let n=`${t}${e.element.documentName}`;this._hookIds.push([n,Hooks.on(n,((e,t,n,i)=>{e.parent==this.object&&mergeObject(this._vue.store,e.parent.toObject(),{performDeletions:!0})}))])}))}}async _updateObject(){this.object?.update&&this._vue.store&&await this.object.update(this._vue.store)}async close(e={}){let t=this.element[0],n=Application.RENDER_STATES,i=e.submit??this.options.submitOnClose;for(let e of(i&&await this.submit({preventClose:!0,preventRender:!0}),this.filepickers))e.close();for(let e of(this.filepickers=[],Object.values(this.editors)))e.mce&&e.mce.destroy();if(this.editors={},e.force||[n.RENDERED,n.ERROR].includes(this._state)){if(this._state=n.CLOSING,!t)return this._state=n.CLOSED;for(let e of this.constructor._getInheritanceChain())Hooks.call(`close${e.name}`,this,this.element);return await new Promise((e=>{t.addEventListener("transitionend",(i=>{this._vue.app.unmount(),this._vue=null,t.remove(),this._element=null,delete ui.windows[this.appId],this._minimized=!1,this._scrollPositions=null,this._state=n.CLOSED,e()}),{once:!0}),Object.assign(t.style,{transformOrigin:"top right",transition:"opacity 0.2s ease-in-out, height 0.2s ease-in-out",opacity:0,height:0})}))}}}var ut=function(){return ut=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var s in t=arguments[n])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},ut.apply(this,arguments)};function dt(e,t){for(var n=e.length;n--;)if(e[n].pointerId===t.pointerId)return n;return-1}function pt(e,t){var n;if(t.touches){n=0;for(var i=0,s=t.touches;i<s.length;i++){var o=s[i];o.pointerId=n++,pt(e,o)}}else(n=dt(e,t))>-1&&e.splice(n,1),e.push(t)}function ht(e){for(var t,n=(e=e.slice(0)).pop();t=e.pop();)n={clientX:(t.clientX-n.clientX)/2+n.clientX,clientY:(t.clientY-n.clientY)/2+n.clientY};return n}function ft(e){if(e.length<2)return 0;var t=e[0],n=e[1];return Math.sqrt(Math.pow(Math.abs(n.clientX-t.clientX),2)+Math.pow(Math.abs(n.clientY-t.clientY),2))}"undefined"!=typeof window&&(window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),"function"!=typeof window.CustomEvent&&(window.CustomEvent=function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:null};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n}));var gt={down:"mousedown",move:"mousemove",up:"mouseup mouseleave"};function mt(e,t,n,i){gt[e].split(" ").forEach((function(e){t.addEventListener(e,n,i)}))}function vt(e,t,n){gt[e].split(" ").forEach((function(e){t.removeEventListener(e,n)}))}"undefined"!=typeof window&&("function"==typeof window.PointerEvent?gt={down:"pointerdown",move:"pointermove",up:"pointerup pointerleave pointercancel"}:"function"==typeof window.TouchEvent&&(gt={down:"touchstart",move:"touchmove",up:"touchend touchcancel"}));var yt,bt="undefined"!=typeof document&&!!document.documentMode;function _t(){return yt||(yt=document.createElement("div").style)}var wt=["webkit","moz","ms"],St={};function Ot(e){if(St[e])return St[e];var t=_t();if(e in t)return St[e]=e;for(var n=e[0].toUpperCase()+e.slice(1),i=wt.length;i--;){var s="".concat(wt[i]).concat(n);if(s in t)return St[e]=s}}function xt(e,t){return parseFloat(t[Ot(e)])||0}function Et(e,t,n){void 0===n&&(n=window.getComputedStyle(e));var i="border"===t?"Width":"";return{left:xt("".concat(t,"Left").concat(i),n),right:xt("".concat(t,"Right").concat(i),n),top:xt("".concat(t,"Top").concat(i),n),bottom:xt("".concat(t,"Bottom").concat(i),n)}}function kt(e,t,n){e.style[Ot(t)]=n}function $t(e){var t=e.parentNode,n=window.getComputedStyle(e),i=window.getComputedStyle(t),s=e.getBoundingClientRect(),o=t.getBoundingClientRect();return{elem:{style:n,width:s.width,height:s.height,top:s.top,bottom:s.bottom,left:s.left,right:s.right,margin:Et(e,"margin",n),border:Et(e,"border",n)},parent:{style:i,width:o.width,height:o.height,top:o.top,bottom:o.bottom,left:o.left,right:o.right,padding:Et(t,"padding",i),border:Et(t,"border",i)}}}function It(e,t){return 1===e.nodeType&&" ".concat(function(e){return(e.getAttribute("class")||"").trim()}(e)," ").indexOf(" ".concat(t," "))>-1}var Tt=/^http:[\w\.\/]+svg$/;var At={animate:!1,canvas:!1,cursor:"move",disablePan:!1,disableZoom:!1,disableXAxis:!1,disableYAxis:!1,duration:200,easing:"ease-in-out",exclude:[],excludeClass:"panzoom-exclude",handleStartEvent:function(e){e.preventDefault(),e.stopPropagation()},maxScale:4,minScale:.125,overflow:"hidden",panOnlyWhenZoomed:!1,pinchAndPan:!1,relative:!1,setTransform:function(e,t,n){var i=t.x,s=t.y,o=t.scale,r=t.isSVG;if(kt(e,"transform","scale(".concat(o,") translate(").concat(i,"px, ").concat(s,"px)")),r&&bt){var a=window.getComputedStyle(e).getPropertyValue("transform");e.setAttribute("transform",a)}},startX:0,startY:0,startScale:1,step:.3,touchAction:"none"};function Dt(e,t){if(!e)throw new Error("Panzoom requires an element as an argument");if(1!==e.nodeType)throw new Error("Panzoom requires an element with a nodeType of 1");if(!function(e){var t=e.ownerDocument,n=e.parentNode;return t&&n&&9===t.nodeType&&1===n.nodeType&&t.documentElement.contains(n)}(e))throw new Error("Panzoom should be called on elements that have been attached to the DOM");t=ut(ut({},At),t);var n=function(e){return Tt.test(e.namespaceURI)&&"svg"!==e.nodeName.toLowerCase()}(e),i=e.parentNode;i.style.overflow=t.overflow,i.style.userSelect="none",i.style.touchAction=t.touchAction,(t.canvas?i:e).style.cursor=t.cursor,e.style.userSelect="none",e.style.touchAction=t.touchAction,kt(e,"transformOrigin","string"==typeof t.origin?t.origin:n?"0 0":"50% 50%");var s,o,r,a,l,c,u=0,d=0,p=1,h=!1;function f(t,n,i){if(!i.silent){var s=new CustomEvent(t,{detail:n});e.dispatchEvent(s)}}function g(t,i,s){var o={x:u,y:d,scale:p,isSVG:n,originalEvent:s};return requestAnimationFrame((function(){"boolean"==typeof i.animate&&(i.animate?function(e,t){var n=Ot("transform");kt(e,"transition","".concat(n," ").concat(t.duration,"ms ").concat(t.easing))}(e,i):kt(e,"transition","none")),i.setTransform(e,o,i),f(t,o,i),f("panzoomchange",o,i)})),o}function m(n,i,s,o){var r=ut(ut({},t),o),a={x:u,y:d,opts:r};if(!r.force&&(r.disablePan||r.panOnlyWhenZoomed&&p===r.startScale))return a;if(n=parseFloat(n),i=parseFloat(i),r.disableXAxis||(a.x=(r.relative?u:0)+n),r.disableYAxis||(a.y=(r.relative?d:0)+i),r.contain){var l=$t(e),c=l.elem.width/p,h=l.elem.height/p,f=c*s,g=h*s,m=(f-c)/2,v=(g-h)/2;if("inside"===r.contain){var y=(-l.elem.margin.left-l.parent.padding.left+m)/s,b=(l.parent.width-f-l.parent.padding.left-l.elem.margin.left-l.parent.border.left-l.parent.border.right+m)/s;a.x=Math.max(Math.min(a.x,b),y);var _=(-l.elem.margin.top-l.parent.padding.top+v)/s,w=(l.parent.height-g-l.parent.padding.top-l.elem.margin.top-l.parent.border.top-l.parent.border.bottom+v)/s;a.y=Math.max(Math.min(a.y,w),_)}else if("outside"===r.contain){y=(-(f-l.parent.width)-l.parent.padding.left-l.parent.border.left-l.parent.border.right+m)/s,b=(m-l.parent.padding.left)/s;a.x=Math.max(Math.min(a.x,b),y);_=(-(g-l.parent.height)-l.parent.padding.top-l.parent.border.top-l.parent.border.bottom+v)/s,w=(v-l.parent.padding.top)/s;a.y=Math.max(Math.min(a.y,w),_)}}return r.roundPixels&&(a.x=Math.round(a.x),a.y=Math.round(a.y)),a}function v(n,i){var s=ut(ut({},t),i),o={scale:p,opts:s};if(!s.force&&s.disableZoom)return o;var r=t.minScale,a=t.maxScale;if(s.contain){var l=$t(e),c=l.elem.width/p,u=l.elem.height/p;if(c>1&&u>1){var d=(l.parent.width-l.parent.border.left-l.parent.border.right)/c,h=(l.parent.height-l.parent.border.top-l.parent.border.bottom)/u;"inside"===t.contain?a=Math.min(a,d,h):"outside"===t.contain&&(r=Math.max(r,d,h))}}return o.scale=Math.min(Math.max(n,r),a),o}function y(e,t,i,s){var o=m(e,t,p,i);return u!==o.x||d!==o.y?(u=o.x,d=o.y,g("panzoompan",o.opts,s)):{x:u,y:d,scale:p,isSVG:n,originalEvent:s}}function b(e,t,n){var i=v(e,t),s=i.opts;if(s.force||!s.disableZoom){e=i.scale;var o=u,r=d;if(s.focal){var a=s.focal;o=(a.x/e-a.x/p+u*e)/e,r=(a.y/e-a.y/p+d*e)/e}var l=m(o,r,e,{relative:!1,force:!0});return u=l.x,d=l.y,p=e,g("panzoomzoom",s,n)}}function _(e,n){var i=ut(ut(ut({},t),{animate:!0}),n);return b(p*Math.exp((e?1:-1)*i.step),i)}function w(t,i,s,o){var r=$t(e),a=r.parent.width-r.parent.padding.left-r.parent.padding.right-r.parent.border.left-r.parent.border.right,l=r.parent.height-r.parent.padding.top-r.parent.padding.bottom-r.parent.border.top-r.parent.border.bottom,c=i.clientX-r.parent.left-r.parent.padding.left-r.parent.border.left-r.elem.margin.left,u=i.clientY-r.parent.top-r.parent.padding.top-r.parent.border.top-r.elem.margin.top;n||(c-=r.elem.width/p/2,u-=r.elem.height/p/2);var d={x:c/a*(a*t),y:u/l*(l*t)};return b(t,ut(ut({},s),{animate:!1,focal:d}),o)}b(t.startScale,{animate:!1,force:!0}),setTimeout((function(){y(t.startX,t.startY,{animate:!1,force:!0})}));var S=[];function O(e){if(!function(e,t){for(var n=e;null!=n;n=n.parentNode)if(It(n,t.excludeClass)||t.exclude.indexOf(n)>-1)return!0;return!1}(e.target,t)){pt(S,e),h=!0,t.handleStartEvent(e),s=u,o=d,f("panzoomstart",{x:u,y:d,scale:p,isSVG:n,originalEvent:e},t);var i=ht(S);r=i.clientX,a=i.clientY,l=p,c=ft(S)}}function x(e){if(h&&void 0!==s&&void 0!==o&&void 0!==r&&void 0!==a){pt(S,e);var n=ht(S),i=S.length>1,u=p;if(i)0===c&&(c=ft(S)),w(u=v((ft(S)-c)*t.step/80+l).scale,n,{animate:!1},e);i&&!t.pinchAndPan||y(s+(n.clientX-r)/u,o+(n.clientY-a)/u,{animate:!1},e)}}function E(e){1===S.length&&f("panzoomend",{x:u,y:d,scale:p,isSVG:n,originalEvent:e},t),function(e,t){if(t.touches)for(;e.length;)e.pop();else{var n=dt(e,t);n>-1&&e.splice(n,1)}}(S,e),h&&(h=!1,s=o=r=a=void 0)}var k=!1;function $(){k||(k=!0,mt("down",t.canvas?i:e,O),mt("move",document,x,{passive:!0}),mt("up",document,E,{passive:!0}))}return t.noBind||$(),{bind:$,destroy:function(){k=!1,vt("down",t.canvas?i:e,O),vt("move",document,x),vt("up",document,E)},eventNames:gt,getPan:function(){return{x:u,y:d}},getScale:function(){return p},getOptions:function(){return function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}(t)},handleDown:O,handleMove:x,handleUp:E,pan:y,reset:function(e){var n=ut(ut(ut({},t),{animate:!0,force:!0}),e);p=v(n.startScale,n).scale;var i=m(n.startX,n.startY,p,n);return u=i.x,d=i.y,g("panzoomreset",n)},resetStyle:function(){i.style.overflow="",i.style.userSelect="",i.style.touchAction="",i.style.cursor="",e.style.cursor="",e.style.userSelect="",e.style.touchAction="",kt(e,"transformOrigin","")},setOptions:function(n){for(var s in void 0===n&&(n={}),n)n.hasOwnProperty(s)&&(t[s]=n[s]);(n.hasOwnProperty("cursor")||n.hasOwnProperty("canvas"))&&(i.style.cursor=e.style.cursor="",(t.canvas?i:e).style.cursor=t.cursor),n.hasOwnProperty("overflow")&&(i.style.overflow=n.overflow),n.hasOwnProperty("touchAction")&&(i.style.touchAction=n.touchAction,e.style.touchAction=n.touchAction)},setStyle:function(t,n){return kt(e,t,n)},zoom:b,zoomIn:function(e){return _(!0,e)},zoomOut:function(e){return _(!1,e)},zoomToPoint:w,zoomWithWheel:function(e,n){e.preventDefault();var i=ut(ut(ut({},t),n),{animate:!1}),s=(0===e.deltaY&&e.deltaX?e.deltaX:e.deltaY)<0?1:-1;return w(v(p*Math.exp(s*i.step/3),i).scale,e,i,e)}}}Dt.defaultOptions=At;class zt extends lt{constructor(e){super(e),this.data=e,this.imagePanZoom=null,this.PanZoomOptions={maxScale:10},this._hookIds=[],this.sceneOptions=null,this.generationOptions=null,this.maxCallCount=4}static installAPI=()=>{};static init=()=>{e.API=game.modules.get(e.ID).flags.API};static get defaultOptions(){return mergeObject(super.defaultOptions,{title:e.TITLE,id:`${e.ID}-dialog`,classes:[],template:`modules/${e.ID}/templates/dungen.vue`,width:window.innerWidth>960?960:window.innerWidth-300,height:window.innerHeight>800?800:window.innerHeight-100})}getThemes(e){let t=["original"];return"dungeon"==e&&(t=t.concat(["ice_temple","stylized_gray","black_white","stylized_white","classic_blue","virtual_world","mask"])),t}getMapSizes(e){return"dungeon"==e?["120","80","40","16","6","4"]:["50","40","30","20","12"]}getTileSizes(t){return[{title:"Default Options",isPatreonLocked:!1,options:["50","70"]},{title:"Patreon Exclusive",isPatreonLocked:e.setting("patreon_values")?.token_expired||!(e.setting("patreon_values")?.patreon_features??[]).includes("Double Resolution (140px grid)"),options:["140"]}]}getGenerationProps(t,n=randomID(12)){const i=t.querySelector('aside input[type="radio"][name="gen_type"]:checked').value;let s={patreon_token:e.setting("patreon_token"),seed:t.querySelector('aside input[type="text"][name="seed"]').value?.length>0?t.querySelector('aside input[type="text"][name="seed"]').value:n,theme:t.querySelector('aside select[name="theme"]').value??"original",max_size:t.querySelector('aside select[name="max_size"]').value??16,tile_size:t.querySelector('aside select[name="tile_size"]').value??70,image_encoded:!0};return"dungeon"==i?mergeObject(s,{multi_level:t.querySelector('aside input[type="checkbox"][name="multi_level"]')?.checked??!1,trap:t.querySelector('aside input[type="checkbox"][name="trap"]')?.checked??!1}):"cave"==i&&mergeObject(s,{map_style:t.querySelector('aside select[name="map_style"]').value??"l_rooms",corridor_density:t.querySelector('aside input[type="range"][name="corridor_density"]').value??0,egress:t.querySelector('aside input[type="range"][name="egress"]').value??1,secret_rooms:t.querySelector('aside input[type="checkbox"][name="secret_rooms"]')?.checked??!1}),s}getData(t={}){const n="dungeon";return{genType:n,moduleId:e.ID,previewImage:`/modules/${e.ID}/images/logo.webp`,requiresRegeneration:!1,hasWallsPermission:!e.setting("patreon_values")?.token_expired&&(e.setting("patreon_values")?.patreon_features??[]).includes("Automatic Walls"),sceneFolders:game.folders.filter((e=>"Scene"===e.type)).map((e=>({id:e.id,name:e.name}))),isDisabled:!1,disable_8k_warning:e.setting("disable_8k_warning")??!1,themes:this.getThemes(n),maxSizes:this.getMapSizes(n),mapStyles:["l_area","l_rooms","s_rooms"],tileSizes:this.getTileSizes(n),inputValues:{name:t.name,folder:t.folder,corridor_density:0,egress:1},mapDetails:!1,setRequiresRegeneration:this._setRequiresRegeneration,onInputRangeWheel:this._onInputRangeWheel,onchangeGenType:this._onchangeGenType,onMountImage:this._onMountImage,generateDungeon:this._generateDungeon,regenerateDungeon:t=>{const n=t.closest(`#${e.ID}-dialog`);let i=n.querySelector('aside select[name="tile_size"]').value;140==i?i=70:70==i&&(i=50),n.querySelector('aside select[name="tile_size"]').value=i,this.generationOptions.tile_size=i,this._generateDungeon({target:t},this.generationOptions.seed)},createScene:this._createScene,checkSize:(e,t)=>{const n=document.createElement("canvas").getContext("webgl");return n.getParameter(n.MAX_TEXTURE_SIZE),{"8k":e<16384&&t<16384&&(e>8192||t>8192),"16k":e>16384||t>16384}},maxTextureSize:e=>{const t=document.createElement("canvas").getContext("webgl"),n=t.getParameter(t.MAX_TEXTURE_SIZE)??8192;return n<(e?.width??0)||n<(e?.height??0)}}}_setRequiresRegeneration=t=>{if(null==this.sceneOptions)return;const n=t.target.closest(`#${e.ID}-dialog`),i=n.querySelector('aside input[type="text"][name="seed"]').value?.length>0?n.querySelector('aside input[type="text"][name="seed"]').value:this.sceneOptions.flags[e.ID].seed_string,s=this.getGenerationProps(n,i),o=this.generationOptions;this._vue.store.requiresRegeneration=!(JSON.stringify(o)==JSON.stringify(s));const r=n.querySelector(`aside .button-group button[id="${e.ID}-btn-generate"]`);this._vue.store.requiresRegeneration?(r.innerHTML=`<i class="fa-light fa-dungeon"></i> ${e.localize("dialog.buttons.generate")}`,r.removeAttribute("data-tooltip")):(r.innerHTML='<i class="fa-light fa-dungeon"></i>',r.setAttribute("data-tooltip",e.localize("dialog.buttons.generate"))),game.tooltip.deactivate()};_onInputRangeWheel=e=>{"corridor_density"==e.target.getAttribute("name")?this._vue.store.inputValues.corridor_density=e.target.value:"egress"==e.target.getAttribute("name")&&(this._vue.store.inputValues.egress=e.target.value),this._setRequiresRegeneration(e)};_onchangeGenType=e=>{const t=e.target.value;this._vue.store.genType=t,this._vue.store.themes=this.getThemes(t),this._vue.store.maxSizes=this.getMapSizes(t),this._vue.store.tileSizes=this.getTileSizes(t),null!=this.sceneOptions&&(this._vue.store.requiresRegeneration=!0,setTimeout((()=>this._setRequiresRegeneration(e)),100))};_onMountImage=e=>{this.imagePanZoom=Dt(e,this.PanZoomOptions??{}),e.closest("main").addEventListener("wheel",this.imagePanZoom.zoomWithWheel)};async updateStatusText(t,n=200){const i=document.querySelector(`#${e.ID}-dialog .window-content`),s=async e=>await new Promise((t=>setTimeout(t,e)));i.hasAttribute("data-status")&&(i.classList.remove("animate-status-text-in"),await s(n)),t&&(i.setAttribute("data-status",t),i.classList.add("animate-status-text-in"),await s(n))}async getMapFromAPI(t,n=0){return await fetch(`${e.API}/fvtt_${this._vue.store.genType}/`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)}).then((e=>e.json())).then((e=>e)).catch((async i=>(n+=1)>=this.maxCallCount?void ui.notifications.error(e.localize("notifications.error.getMapFromAPI")):(this.updateStatusText(e.localize("dialog.status.largeMap")),await this.getMapFromAPI(t,n))))}_generateDungeon=async(t,n=randomID(12))=>{const i=t.target.closest(`#${e.ID}-dialog`),s=i.querySelector(`aside .button-group button[id="${e.ID}-btn-generate"]`);i.querySelector("main").setAttribute("data-theme","none"),s.removeAttribute("data-tooltip"),game.tooltip.deactivate(),s.innerHTML=`<i class="fa-solid fa-spinner fa-spin-pulse"></i> ${e.localize("dialog.buttons.building")}`,this._vue.store.isDisabled=!0;const o=`/modules/${e.ID}/images/logo.webp`;i.querySelector("main img").setAttribute("src",o),this.imagePanZoom.zoom(1),this.imagePanZoom.pan(0,0),this.generationOptions=this.getGenerationProps(i,n),this._vue.store.requiresRegeneration=!1,this._vue.store.mapDetails=!1;const r=await this.getMapFromAPI(mergeObject(this.generationOptions,{tile_size:(()=>{const e=parseInt(i.querySelector('aside select[name="max_size"]').value??16),t=parseInt(i.querySelector('aside select[name="tile_size"]').value??70);return e>=40?30:e<40&&t>70?70:t})()},{inplace:!1}));if(void 0===r)return this._vue.store.isDisabled=!1,!1;r?.image_url&&(i.querySelector("main img").setAttribute("src",`data:image/jpeg;charset=utf-8;base64,${r?.image_encoded}`),i.querySelector("main").setAttribute("data-theme",this.generationOptions.theme),r.max_tile_size=r.max_tile_size.split(" x "),this._vue.store.mapDetails={max_tile_size:r.max_tile_size,pixel_size:{height:r.max_tile_size[1]*parseInt(i.querySelector('aside select[name="tile_size"]').value),width:r.max_tile_size[0]*parseInt(i.querySelector('aside select[name="tile_size"]').value)},seed_string:r.seed_string},this.sceneOptions={background:{src:`data:image/jpeg;charset=utf-8;base64,${r?.image_encoded}`},flags:{[`${e.ID}`]:mergeObject({generationDetails:this.generationOptions,image_url:`${e.API.replace("/api","")}/${r.image_url.replace("../","")}`},this._vue.store.mapDetails,{inplace:!1})},grid:{type:1,size:parseInt(i.querySelector('aside select[name="tile_size"]').value)},height:this._vue.store.mapDetails.pixel_size.height,name:i.querySelector('input[type="text"][name="name"').value,width:this._vue.store.mapDetails.pixel_size.width},i.querySelector('aside select[name="folder"]').value.length>0&&(this.sceneOptions.folder=game.folders.find((e=>"Scene"===e.type&&e.id==i.querySelector('aside select[name="folder"]').value))),this._vue.store.requiresRegeneration=!1,s.innerHTML='<i class="fa-light fa-dungeon"></i>',s.setAttribute("data-tooltip",e.localize("dialog.buttons.generate")),this._vue.store.isDisabled=!1)};_createScene=async t=>{t.preventDefault();const n=t.target.closest(`#${e.ID}-dialog`);n.querySelector(".window-content"),n.classList.add("processing"),this.updateStatusText(e.localize("dialog.status.start")),this._vue.store.isDisabled=!0,this.sceneOptions.name=n.querySelector('input[type="text"][name="name"').value,0==this.sceneOptions.name.length&&(this.sceneOptions.name=game.i18n.format("DOCUMENT.New",{type:game.i18n.translations.DOCUMENT.Scene}),game.scenes?.size&&(this.sceneOptions.name+=` (${game.scenes?.size+1})`)),n.querySelector('aside select[name="folder"]').value.length>0&&(this.sceneOptions.folder=game.folders.find((e=>"Scene"===e.type&&e.id==n.querySelector('aside select[name="folder"]').value)));const i=parseInt(n.querySelector('aside select[name="tile_size"]').value??70);if("cave"==this._vue.store.genType){this.updateStatusText(e.localize("dialog.status.getMap"));const t=await this.getMapFromAPI(mergeObject(this.generationOptions,{layout:!1},{inplace:!1}));if(void 0===t)return;this.sceneOptions.background.src=`data:image/jpeg;charset=utf-8;base64,${t.image_encoded}`}else if(this.generationOptions.max_size>=40||this.generationOptions.max_size<=16&&i>70){this.updateStatusText(e.localize("dialog.status.getMap"));const t=await this.getMapFromAPI(this.generationOptions);if(void 0===t)return;this.sceneOptions.background.src=`data:image/jpeg;charset=utf-8;base64,${t.image_encoded}`}n.querySelector('input[type="checkbox"][name="green_path"').checked&&(this.updateStatusText(e.localize("dialog.status.getWalls")),this.sceneOptions.walls=(await this.getMapFromAPI(mergeObject(this.generationOptions,{theme_selected:"dungeon"==this._vue.store.genType?"mask":"original",green_path:"fvtt"}))).walls??[],0==this.sceneOptions.walls.length&&ui.notifications.warn(e.localize("notifications.warning.noWalls"))),this.updateStatusText(e.localize("dialog.status.savingMap"));const s=await this.createImage(this.sceneOptions.background.src,this.sceneOptions.flags[e.ID].image_url);if(!s)return;this.sceneOptions.background.src=s?.path??"",this.updateStatusText(e.localize("dialog.status.creatingScene"));const o=await Scene.create(mergeObject({type:"base"},this.sceneOptions));return await o.sheet.render(!0),n.classList.remove("processing"),this.updateStatusText(),await super.close()};async createSceneFolder(t){return await FilePicker.browse("user",`${e.setting("scene_storage")}`,{}).then((e=>e.files)).then((e=>e)).catch((e=>!1))||await FilePicker.createDirectory("user",`${e.setting("scene_storage")}`,{}),`${e.setting("scene_storage")}`}async createImage(t,n){n=n.split("/").pop();const i=await this.createSceneFolder(),s=await fetch(t).then((e=>e.arrayBuffer())).then((e=>new File([e],n,{type:"image/jpeg"}))).catch((t=>(ui.notifications.error(e.localize("notifications.errors.createImage")),!1)));return s?await FilePicker.upload("data",i,s):s}activateListeners(t){this._hookIds.push(["updateSetting",Hooks.on("updateSetting",(async(t,n,i,s)=>{[`${e.ID}.patreon_values`,`${e.ID}.disable_8k_warning`].includes(t.key)&&(t.key===`${e.ID}.patreon_values`?(this._vue.store.tileSizes=this.getTileSizes(this._vue.store.genType),this._vue.store.hasWallsPermission=!e.setting("patreon_values")?.token_expired&&(e.setting("patreon_values")?.patreon_features??[]).includes("Automatic Walls")):t.key===`${e.ID}.disable_8k_warning`&&(this._vue.store.disable_8k_warning="true"===n.value))}))]),["create","update","delete"].forEach((e=>{this._hookIds.push([`${e}Folder`,Hooks.on(`${e}Folder`,(async(e,t,n)=>{"Scene"==e.type&&(this._vue.store.sceneFolders=game.folders.filter((e=>"Scene"===e.type)).map((e=>({id:e.id,name:e.name}))))}))])})),this.data.name?this.data.folder?t[0].querySelector('aside input[type="radio"][name="gen_type"][value="dungeon"]').focus():t[0].querySelector('aside select[name="folder"]').focus():t[0].querySelector('aside input[name="name"]').focus()}async close(e={}){return this._hookIds.forEach((e=>Hooks.off(...e))),await super.close()}}let Pt;Hooks.once("setup",(async()=>{const t=async t=>await fetch(`${e.API}/fvtt_token/`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({patreon_token:t})}).then((e=>e.json()));e.setting("register","scene_storage",{type:String,default:"DunGen Scenes",scope:"world",filePicker:"folder"}),e.setting("register","show_in_sidebar",{type:Boolean,default:!0,scope:"world",config:!0,onChange:t=>{const n=document.querySelector('#sidebar section.tab[data-tab="scenes"]');t?(Array.from(n.querySelectorAll(".header-actions")).pop().insertAdjacentHTML("beforeend",`<button class="create-dungen" data-button="dungen">\n\t\t\t\t<i class="fa-light fa-dungeon"></i> ${e.TITLE}\n\t\t\t</button>`),n.querySelector('.header-actions.action-buttons button[data-button="dungen"]').addEventListener("click",(e=>{new zt({name:"",folder:""}).render(!0)}))):n.querySelector('.header-actions.action-buttons button[data-button="dungen"]')?.remove()}}),e.setting("register","disable_8k_warning",{type:Boolean,default:!1,scope:"world",config:!0,onChange:t=>{e.log(t)}}),e.setting("register","patreon_token",{type:String,default:"",scope:"world",onChange:async n=>{if(""==n)return e.setting("patreon_values",{});e.setting("patreon_values",await t(n))}}),e.setting("register","patreon_values",{type:Object,default:{},scope:"world",config:!1}),Hooks.once("ready",(async()=>{""!=e.setting("patreon_token")&&(isEmpty(e.setting("patreon_values"))&&await e.setting("patreon_values",await t(e.setting("patreon_token"))),e.setting("patreon_values")?.token_expired||new Date(e.setting("patreon_values").expiry)<(new Date).setHours(0,0,0,0)&&(ui.notifications.warn(`<strong>${e.TITLE}</strong> ${e.localize("notifications.token_expired")}`),e.setting("patreon_values",mergeObject(e.setting("patreon_values"),{token_expired:!0}))))})),Hooks.on("renderSettingsConfig",(async(t,n,i)=>{if(!game.user.isGM)return;let s=n[0].querySelector(`section[data-tab="${e.ID}"] .form-fields input[name="${e.ID}.patreon_token"]`);s.setAttribute("type","password"),s.insertAdjacentHTML("afterend",'<button><i class="fa-solid fa-eye"></i></button>'),s.nextElementSibling.addEventListener("click",(e=>{e.preventDefault(),s.setAttribute("type","password"==s.getAttribute("type")?"text":"password"),s.nextElementSibling.querySelector("i").classList.toggle("fa-eye","password"==s.getAttribute("type")),s.nextElementSibling.querySelector("i").classList.toggle("fa-eye-slash","password"!=s.getAttribute("type"))})),isEmpty(e.setting("patreon_values"))?n[0].querySelector(`section[data-tab="${e.ID}"] .form-group:last-of-type`).insertAdjacentHTML("afterend",`<div class="form-group notification" style="box-shadow: none; text-shadow: none;">\n\t\t\t\t<div>${e.localize("notifications.patreon_signup")}</div>\n\t\t\t</div>`):e.setting("patreon_values")?.patreon_pledge||e.setting("patreon_values")?.patreon_features||"Invalid Date"!=new Date(e.setting("patreon_values")?.expiry??"")?n[0].querySelector(`section[data-tab="${e.ID}"] .form-group:last-of-type`).insertAdjacentHTML("afterend",`<div class="form-group patreon-status">\n\t\t\t\t${new Date(e.setting("patreon_values").expiry)<(new Date).setHours(0,0,0,0)?`<div class="form-group notification warning"><div>${e.localize("notifications.invalid_token_data")}</div></div>`:""}\n\t\t\t\t<div><strong>${e.localize("settings.patreon.tier")}:</strong> ${e.setting("patreon_values")?.patreon_pledge??""}</div>\n\t\t\t\t<div><strong>${e.localize("settings.patreon.features")}:</strong> ${(e.setting("patreon_values")?.patreon_features??[]).join(", ")}</div>\n\t\t\t\t<div><strong>${e.localize("settings.patreon.expires")}:</strong> ${new Date(e.setting("patreon_values")?.expiry??"").toLocaleDateString()}</div>\n\t\t\t</div>`):n[0].querySelector(`section[data-tab="${e.ID}"] .form-group:last-of-type`).insertAdjacentHTML("afterend",`<div class="form-group notification error" style="box-shadow: none; text-shadow: none;">\n\t\t\t\t<div><strong>${e.TITLE}</strong> ${e.localize("notifications.invalid_token_data")}</div>\n\t\t\t</div>`)})),Hooks.on("renderSidebarTab",(async(t,n,i)=>{"scenes"===t.id&&e.setting("show_in_sidebar")&&game.user.isGM&&(Array.from(n[0].querySelectorAll(".header-actions")).pop().insertAdjacentHTML("beforeend",'<button class="dialog-button" data-button="dungen">\n\t\t\t<i class="fa-light fa-dungeon"></i> DunGen\n\t\t</button>'),n[0].querySelector('.header-actions.action-buttons button[data-button="dungen"]').addEventListener("click",(e=>{new zt({name:"",folder:""}).render(!0)})))}))}));const Lt=new RegExp("([^.[]+|\\[('([^'\\\\]|\\\\.)+?'|\"([^\"\\\\]|\\\\.)+?\")\\])","g"),jt=new RegExp("(^\\['|'\\]$|^\\[\"|\"\\]$)","g");Hooks.once("init",(()=>{if(!globalThis.libWrapper||(globalThis.libWrapper.is_fallback??1)){Pt=class{static get is_fallback(){return!0}static get WRAPPER(){return"WRAPPER"}static get MIXED(){return"MIXED"}static get OVERRIDE(){return"OVERRIDE"}static register(e,t,n,i="MIXED",{chain:s,bind:o=[]}={}){const r=t.endsWith("#set"),a=(t=r?t.slice(0,-4):t).match(Lt).map((e=>e.replace(/\\(.)/g,"$1").replace(jt,""))),l=a.splice(0,1)[0];let c,u;if(0==a.length)c=globalThis,u=l;else{const e=eval;u=a.pop(),c=a.reduce(((e,t)=>e[t]),globalThis[l]??e(l))}let d=c,p=null;for(;d&&(p=Object.getOwnPropertyDescriptor(d,u),!p);)d=Object.getPrototypeOf(d);if(!p||!1===p?.configurable)throw new Error(`libWrapper Shim: '${t}' does not exist, could not be found, or has a non-configurable descriptor.`);let h=null;const f=s??("OVERRIDE"!=i.toUpperCase?.()&&3!=i)?function(...e){return n.call(this,h.bind(this),...o,...e)}:function(...e){return n.call(this,...o,...e)};if(r){if(!p.set)throw new Error(`libWrapper Shim: '${t}' does not have a setter`);h=p.set,p.set=f}else p.value?(h=p.value,p.value=f):(h=p.get,p.get=f);p.configurable=!0,Object.defineProperty(c,u,p)}};{const[e,t]=(()=>{const e=(import.meta?.url??Error().stack)?.match(/\/(worlds|systems|modules)\/(.+)(?=\/)/i);if(3!==e?.length)return[null,null];const t=e[2].split("/");if("worlds"===e[1])return t.find((e=>e&&game.world.id===e))?[game.world.id,game.world.title]:[null,null];if("systems"===e[1])return t.find((e=>e&&game.system.id===e))?[game.system.id,game.system.title??game.system.data.title]:[null,null];const n=t.find((e=>e&&game.modules.has(e))),i=game.modules.get(n);return[n,i?.title??i?.data?.title]})();if(!e||!t)return void console.error("libWrapper Shim: Could not auto-detect package ID and/or title. The libWrapper fallback warning dialog will be disabled.")}}else Pt=globalThis.libWrapper})),Hooks.once("devModeReady",(({registerPackageDebugFlag:t})=>{t(e.ID,"level",{choiceLabelOverrides:{0:"NONE",1:"ERROR",2:"WARN",3:"DEBUG",4:"INFO",5:"ALL"}})})),Hooks.once("ready",(async()=>{game.user.isGM&&Pt.register(e.ID,"Scene.createDialog",(async function(t={},{parent:n=null,pack:i=null,...s}={}){const o=this.metadata.name,r=game.documentTypes[o],a=n?[]:game.folders.filter((e=>e.type===o&&e.displayed)),l=game.i18n.localize(this.metadata.label),c=game.i18n.format("DOCUMENT.Create",{type:l}),u=await renderTemplate("templates/sidebar/document-create.html",{folders:a,name:t.name||game.i18n.format("DOCUMENT.New",{type:l}),folder:t.folder,hasFolders:a.length>=1,type:t.type||CONFIG[o]?.defaultType||r[0],types:r.reduce(((e,t)=>{const n=CONFIG[o]?.typeLabels?.[t]??t;return e[t]=game.i18n.has(n)?game.i18n.localize(n):t,e}),{}),hasTypes:r.length>1});return Dialog.confirm({title:c,content:u,render:t=>{t[2].querySelector('button[data-button="yes"]').innerHTML=`<i class="fas fa-check"></i> ${c}`,t[2].querySelector('button[data-button="no"]').innerHTML=`<i class="fa-light fa-dungeon"></i> ${e.TITLE}`},yes:e=>{const s=e[0].querySelector("form"),o=new FormDataExtended(s);return foundry.utils.mergeObject(t,o.object,{inplace:!0}),t.folder||delete t.folder,1===r.length&&(t.type=r[0]),t.name?.trim()||(t.name=this.defaultName()),this.create(t,{parent:n,pack:i,renderSheet:!0})},no:e=>{new zt({name:e[0].querySelector('input[name="name"]').value??"",folder:e[0].querySelector('select[name="folder"]')?.value??""}).render(!0)},rejectClose:!1,options:s})}),"OVERRIDE")})),Hooks.once("ready",(async()=>{game.user.isGM&&zt.init()}));